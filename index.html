<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CSV Map with Clustering</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  </head>
  <body>
    <div id="map" style="height: 100vh"></div>
    <script>
      const map = L.map("map").setView([52.5, -1.2], 7);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "Â© OpenStreetMap contributors",
      }).addTo(map);

      // Create a MarkerClusterGroup
      const markers = L.markerClusterGroup();

      // Parse CSV with Papa Parse
      Papa.parse("converted_coordinates.csv", {
        download: true,
        header: true, // Treat the first row as headers
        skipEmptyLines: true,
        complete: function (results) {
          console.log("Parsed CSV:", results.data);

          results.data.forEach((row) => {
            // Extract lat/lon (assuming correct header names in the CSV)
            const lat = parseFloat(row.latitude); // Update 'latitude' if the column header differs
            const lon = parseFloat(row.longitude);

            // Extract name from the "name" column
            const locationName = row.Name || "Unnamed Location"; // Fallback if 'name' is empty

            // Validate lat/lon
            if (!isNaN(lat) && !isNaN(lon)) {
              const marker = L.marker([lat, lon]).bindPopup(
                `<b>${locationName}</b><br>${row.description || ""}`
              );

              // Add marker to the cluster group
              markers.addLayer(marker);
            } else {
              console.warn(`Invalid LatLng for row:`, row);
            }
          });

          // Add the cluster group to the map
          map.addLayer(markers);
        },
        error: function (error) {
          console.error("Error parsing CSV:", error);
        },
      });
    </script>
  </body>
</html>
